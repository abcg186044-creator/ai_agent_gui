FROM python:3.10-slim

RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    pkg-config \
    portaudio19-dev \
    python3-dev \
    python3-setuptools \
    alsa-utils \
    libasound2-dev \
    libportaudio2 \
    libportaudiocpp0 \
    espeak \
    espeak-ng \
    espeak-data \
    libespeak1 \
    libespeak-dev \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

RUN pip install --upgrade pip
RUN pip install --no-cache-dir --upgrade pip setuptools wheel
RUN pip install --no-cache-dir streamlit==1.28.1
RUN pip install --no-cache-dir sounddevice==0.4.6
RUN pip install --no-cache-dir pyttsx3==2.90
RUN pip install --no-cache-dir numpy==1.24.3
RUN pip install --no-cache-dir torch==2.1.0 torchaudio==2.1.0
RUN pip install --no-cache-dir "faster-whisper>=1.0.3"
RUN pip install --no-cache-dir requests==2.31.0
RUN pip install --no-cache-dir fastapi==0.128.0
RUN pip install --no-cache-dir uvicorn==0.40.0

COPY browser_audio_component.py /app/browser_audio_component.py
COPY ollama_vrm_integrated_app.py /app/ollama_vrm_integrated_app.py
COPY fastapi_server.py /app/fastapi_server.py
COPY static/ /app/static/

EXPOSE 8501 8000

CMD ["streamlit", "run", "ollama_vrm_integrated_app.py", "--server.port=8501", "--server.address=0.0.0.0", "--server.headless=true", "--browser.gatherUsageStats=false", "--server.enableCORS=false", "--server.enableXsrfProtection=false", "--logger.level=error", "--client.showErrorDetails=false"]
