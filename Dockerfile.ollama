# Ollama with Preloaded Models
FROM ollama/ollama:latest

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /app

# å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    && rm -rf /var/lib/apt/lists/*

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼
COPY scripts/download_models.sh /app/download_models.sh
COPY scripts/preload_models.sh /app/preload_models.sh

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
RUN chmod +x /app/download_models.sh
RUN chmod +x /app/preload_models.sh

# ãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œï¼‰
RUN /app/download_models.sh

# ãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
RUN echo "ğŸ“ Model directory contents:" && ls -la /root/.ollama/models/ || echo "No models directory yet"

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®è¨­å®š
ENTRYPOINT ["/app/preload_models.sh"]

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:11434/api/tags || exit 1

# ãƒãƒ¼ãƒˆã®å…¬é–‹
EXPOSE 11434
