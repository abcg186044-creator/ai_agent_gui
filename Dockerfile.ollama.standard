# Ollama + VRM + 音声認識 標準Dockerfile（CPU版）
FROM ubuntu:22.04

# 環境変数設定
ENV DEBIAN_FRONTEND=noninteractive
ENV OLLAMA_HOST=0.0.0.0
ENV OLLAMA_PORT=11434
ENV PATH="/opt/venv/bin:$PATH"

# 基本パッケージインストール
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    python3.10 \
    python3.10-dev \
    python3-pip \
    python3-venv \
    build-essential \
    pkg-config \
    portaudio19-dev \
    ffmpeg \
    espeak-ng \
    zstd \
    && rm -rf /var/lib/apt/lists/*

# Python環境設定
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.10 1
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1
RUN update-alternatives --install /usr/bin/pip pip /usr/bin/pip3 1

# Ollamaインストール
RUN curl -fsSL https://ollama.com/install.sh | sh

# Python仮想環境作成
RUN python -m venv /opt/venv

# Pythonライブラリインストール
RUN /opt/venv/bin/pip install --upgrade pip setuptools wheel

# 音声処理ライブラリ
RUN /opt/venv/bin/pip install --no-cache-dir \
    streamlit==1.28.1 \
    sounddevice==0.4.6 \
    pyttsx3==2.90 \
    numpy==1.24.3 \
    scipy==1.15.3 \
    torch==2.1.0 \
    torchaudio==2.1.0 \
    "faster-whisper>=1.0.3" \
    requests==2.31.0 \
    fastapi==0.128.0 \
    uvicorn==0.40.0 \
    python-multipart==0.0.6

# 作業ディレクトリ
WORKDIR /app

# アプリケーションファイルコピー
COPY browser_audio_component_fixed.py /app/browser_audio_component_fixed.py
COPY ollama_vrm_integrated_app.py /app/ollama_vrm_integrated_app.py
COPY fastapi_server.py /app/fastapi_server.py
COPY static/ /app/static/
COPY start.sh /app/start.sh

# 起動スクリプトに実行権限
RUN chmod +x /app/start.sh

# ポート公開
EXPOSE 8501 8000 11434

# 起動コマンド
CMD ["/app/start.sh"]
